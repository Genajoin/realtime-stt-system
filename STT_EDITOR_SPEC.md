# Техническое задание: Минималистичный STT редактор

## 1. Общее описание проекта

### Название
**websocket_minimal_editor.py** - Минималистичный терминальный редактор с поддержкой STT (Speech-To-Text)

### Назначение
Создание легковесного терминального текстового редактора с интеграцией распознавания речи, оптимизированного для работы в маленьких окнах терминала без лишних элементов интерфейса.

### Целевое применение
- Быстрый ввод текста голосом с последующим редактированием
- Работа в минимальных терминальных окнах
- Копирование результата в буфер обмена для использования в других приложениях

## 2. Функциональные требования

### 2.1 Основные функции

#### Текстовое редактирование
- [x] Многострочный ввод и редактирование текста
- [x] Перемещение курсора клавишами стрелок
- [x] Позиционирование курсора мышью
- [x] Выделение текста мышью (drag selection)
- [x] Вставка/удаление символов и строк
- [x] Поддержка UTF-8 (кириллица, эмодзи и т.д.)

#### STT интеграция
- [x] WebSocket подключение к существующему STT серверу
- [x] Запуск/остановка записи голоса
- [x] Вставка распознанного текста в текущую позицию курсора
- [x] Индикация статуса записи в статус баре
- [x] Обработка real-time и финальной транскрипции

#### Работа с буфером обмена
- [x] Автоматическое копирование распознанного текста в буфер
- [x] Копирование выделенного текста (Ctrl+C)
- [x] Копирование всего содержимого редактора (F3)
- [x] Интеграция с системным буфером обмена

### 2.2 Интерфейс пользователя

#### Визуальное оформление
- [x] **БЕЗ БОРДЮРОВ** - чистое поле редактирования
- [x] **БЕЗ РАМОК** - для корректного копирования многострочного текста
- [x] Использование полной ширины терминала
- [x] Минимальная статус строка (1 строка) внизу экрана
- [x] Оптимизация для маленьких окон терминала

#### Цветовая схема
- [x] Нейтральные цвета для основного текста
- [x] Контрастное выделение активного текста
- [x] Статус индикаторы: зеленый (подключен), красный (запись), серый (ожидание)

#### Статус бар (снизу)
```
[●REC] F1:Start F2:Stop F3:Copy Ctrl+C:CopySelected Ctrl+Q:Exit    [Connected]
```

### 2.3 Управление

#### Функциональные клавиши
- **F1** - Начать запись STT
- **F2** - Остановить запись STT
- **F3** - Копировать весь текст в буфер обмена

#### Системные комбинации
- **Ctrl+C** - Копировать выделенный текст
- **Ctrl+A** - Выделить весь текст
- **Ctrl+Q** - Выход из приложения

#### Навигация
- **Стрелки** - Перемещение курсора
- **Page Up/Down** - Постраничная прокрутка
- **Home/End** - Начало/конец строки
- **Ctrl+Home/End** - Начало/конец документа

#### Мышь
- **Левый клик** - Позиционирование курсора
- **Drag** - Выделение текста
- **Ctrl+Левый клик** - Выделение слов

## 3. Технические требования

### 3.1 Архитектура приложения

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  EDITOR AREA (полная ширина, без рамок)                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Buffer: многострочный текст                         │    │
│  │ Cursor: позиция ввода                               │    │
│  │ Selection: выделенный текст                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
[●REC] F1:Start F2:Stop F3:Copy Ctrl+Q:Exit         [Connected] <- Статус бар
```

### 3.2 Компоненты системы

#### Core Components
1. **MinimalSTTEditor** - основной класс приложения
2. **STTBuffer** - текстовый буфер с STT интеграцией
3. **WebSocketSTTClient** - клиент для подключения к STT серверу
4. **ClipboardManager** - менеджер буфера обмена
5. **StatusBar** - строка состояния

#### prompt_toolkit Components
- **Buffer** - основное хранилище текста
- **BufferControl** - контроллер для редактирования
- **Window** - окно без рамок
- **Layout** - минимальный layout (окно + статус)
- **Application** - главное приложение

### 3.3 Взаимодействие с STT сервером

#### WebSocket подключение
- **Control канал**: `ws://genaminipc.awg:8011`
- **Data канал**: `ws://genaminipc.awg:8012`
- **Конфигурация**: Загрузка из .env файла

#### Обработка STT данных
1. **Real-time транскрипция** - показ предварительного текста
2. **Final транскрипция** - вставка финального текста в Buffer
3. **Автокопирование** - каждый финальный текст копируется в clipboard

### 3.4 Техническая реализация

#### Основные библиотеки
- **prompt_toolkit** - TUI framework
- **websockets** - WebSocket client
- **pyperclip** - системный буфер обмена
- **asyncio** - асинхронное выполнение
- **pyaudio** - захват аудио

#### Файловая структура
```
websocket_minimal_editor.py    # Основной файл приложения
STT_EDITOR_SPEC.md            # Техническое задание (этот файл)
.env                          # Конфигурация (существующий)
```

## 4. Детальная спецификация

### 4.1 Класс MinimalSTTEditor

```python
class MinimalSTTEditor:
    def __init__(self):
        # Основные компоненты
        self.buffer = Buffer()  # Основной текстовый буфер
        self.stt_client = WebSocketSTTClient()  # STT клиент
        self.clipboard_manager = ClipboardManager()  # Буфер обмена

        # UI компоненты
        self.buffer_control = BufferControl(buffer=self.buffer)
        self.editor_window = Window(content=self.buffer_control, wrap_lines=True)
        self.status_bar = StatusBar()

        # Layout без рамок
        self.layout = HSplit([
            self.editor_window,  # Главная область редактора
            self.status_bar      # Статус бар (1 строка)
        ])

        # Application
        self.app = Application(
            layout=Layout(self.layout),
            key_bindings=self.create_key_bindings(),
            full_screen=True,
            mouse_support=True
        )

    async def run(self):
        # Основной цикл приложения

    def create_key_bindings(self):
        # Настройка клавиатурных сочетаний

    async def on_stt_text_received(self, text: str, is_final: bool):
        # Обработка текста от STT сервера

    def insert_text_at_cursor(self, text: str):
        # Вставка текста в позицию курсора

    def copy_to_clipboard(self, text: str):
        # Копирование в системный буфер обмена
```

### 4.2 Обработка STT данных

#### Алгоритм обработки
1. **Подключение к WebSocket серверам** (control и data каналы)
2. **Запуск аудио захвата** при нажатии F1
3. **Передача аудио данных** на STT сервер
4. **Получение транскрипции**:
   - Real-time: предварительный показ
   - Final: вставка в Buffer + автокопирование
5. **Остановка записи** при нажатии F2

#### Вставка текста
```python
async def insert_stt_text(self, text: str, is_final: bool):
    if is_final:
        # Вставить в текущую позицию курсора
        current_text = self.buffer.text
        cursor_pos = self.buffer.cursor_position

        new_text = current_text[:cursor_pos] + text + current_text[cursor_pos:]
        self.buffer.text = new_text
        self.buffer.cursor_position = cursor_pos + len(text)

        # Автокопирование финального текста
        await self.clipboard_manager.copy_text(text)
    else:
        # Real-time предварительный показ (опционально)
        pass
```

### 4.3 Буфер обмена

#### Функции копирования
1. **Автокопирование STT** - каждый финальный текст от STT
2. **Копирование выделенного** (Ctrl+C) - текст в selection
3. **Копирование всего** (F3) - весь контент Buffer

#### Интеграция с системой
- Использование `pyperclip` для кроссплатформенной совместимости
- Обработка ошибок доступа к clipboard
- Индикация успешного копирования в статус баре

### 4.4 Статус бар

#### Отображаемая информация
- **Индикатор записи**: `[●REC]` - красный при записи
- **Горячие клавиши**: краткая справка по функциональным клавишам
- **Статус соединения**: `[Connected]`, `[Connecting...]`, `[Disconnected]`
- **Индикатор копирования**: `[Copied!]` - кратковременно после копирования

#### Макет статус бара
```python
def get_status_bar_text(self) -> List[Tuple[str, str]]:
    status_items = []

    # Индикатор записи
    if self.is_recording:
        status_items.append(('class:status-recording', '[●REC] '))
    else:
        status_items.append(('class:status-idle', '[○] '))

    # Горячие клавиши
    status_items.append(('', 'F1:Start F2:Stop F3:Copy Ctrl+Q:Exit '))

    # Статус соединения (справа)
    if self.stt_client.is_connected:
        status_items.append(('class:status-connected', ' [Connected]'))
    else:
        status_items.append(('class:status-disconnected', ' [Disconnected]'))

    return status_items
```

## 5. План тестирования

### 5.1 Функциональное тестирование
- [x] Базовое редактирование текста
- [x] Навигация курсором (клавиатура + мышь)
- [x] Выделение текста мышью
- [x] Копирование в буфер обмена
- [x] STT интеграция (запись, остановка, вставка)
- [x] WebSocket подключение

### 5.2 Тестирование интерфейса
- [x] Работа в маленьких окнах терминала (80x24, 60x20)
- [x] Отсутствие артефактов при копировании
- [x] Корректное отображение статус бара
- [x] Отзывчивость мыши

### 5.3 Стресс тестирование
- [x] Длинные тексты (>1000 строк)
- [x] Непрерывная STT запись
- [x] Множественные операции копирования
- [x] Восстановление WebSocket соединения

## 6. Критерии готовности

### Минимально жизнеспособный продукт (MVP)
- [x] Редактор без рамок работает в терминале
- [x] STT подключение и запись функционируют
- [x] Текст вставляется в позицию курсора
- [x] Автокопирование в системный буфер
- [x] Базовые горячие клавиши работают

### Полная версия
- [x] Поддержка мыши для выделения
- [x] Оптимизация для маленьких экранов
- [x] Обработка всех ошибок подключения
- [x] Корректная работа с русским и английским текстом
- [x] Стабильность при длительной работе

## 7. Ограничения и допущения

### Ограничения
- Работа только с существующим STT сервером (genaminipc.awg:8011/8012)
- Зависимость от pyperclip для буфера обмена
- Требуется Python 3.7+ для asyncio

### Допущения
- STT сервер доступен и функционирует
- Терминал поддерживает UTF-8
- Системный буфер обмена доступен
- Пользователь знаком с базовыми горячими клавишами

## 8. Развитие проекта

### Возможные улучшения
- Настраиваемые горячие клавиши
- Сохранение истории текста
- Поддержка табов/отступов
- Темы оформления
- Конфигурационный файл для редактора

### Интеграции
- Экспорт в различные форматы
- API для внешних приложений
- Плагины для расширения функциональности

---

**Версия документа**: 1.0
**Дата создания**: 2025-09-25
**Статус**: Готов к реализации