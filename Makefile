# Makefile –¥–ª—è Realtime STT System
# –ö–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ WebSocket

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PYTHON := python3

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: help install install-mac run docker-build docker-run docker-stop docker-logs docker-status deploy remote-logs remote-status clean check-platform

# –ü–æ–º–æ—â—å (–∫–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
help:
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë          Realtime STT System Commands          ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(GREEN)–£—Å—Ç–∞–Ω–æ–≤–∫–∞:$(NC)"
	@echo "  $(YELLOW)make install$(NC)               - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ .venv (Linux)"
	@echo "  $(YELLOW)make install-mac$(NC)           - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è macOS"
	@echo "  $(YELLOW)make check-platform$(NC)         - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"
	@echo ""
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫:$(NC)"
	@echo "  $(YELLOW)make run$(NC)                   - –ó–∞–ø—É—Å–∫ STT –∫–ª–∏–µ–Ω—Ç–∞"
	@echo ""
	@echo "$(GREEN)Docker –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@echo "  $(YELLOW)make docker-build$(NC)         - –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞"
	@echo "  $(YELLOW)make docker-run$(NC)           - –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
	@echo "  $(YELLOW)make docker-stop$(NC)          - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
	@echo "  $(YELLOW)make docker-logs$(NC)          - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
	@echo "  $(YELLOW)make docker-status$(NC)        - –°—Ç–∞—Ç—É—Å –∏ —Ä–µ—Å—É—Ä—Å—ã"
	@echo ""
	@echo "$(GREEN)–£–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:$(NC)"
	@echo "  $(YELLOW)make deploy$(NC)               - –î–µ–ø–ª–æ–π –Ω–∞ genaminipc.awg"
	@echo "  $(YELLOW)make remote-logs$(NC)          - –õ–æ–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞"
	@echo "  $(YELLOW)make remote-status$(NC)        - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞"
	@echo ""
	@echo "$(GREEN)–£—Ç–∏–ª–∏—Ç—ã:$(NC)"
	@echo "  $(YELLOW)make clean$(NC)                - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

install:
	@echo "$(BLUE)üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(NC)"
	@$(PYTHON) -m venv .venv
	@echo "$(BLUE)üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(NC)"
	@. .venv/bin/activate && pip install --upgrade pip
	@echo "$(BLUE)üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	@. .venv/bin/activate && pip install -e .
	@echo "$(GREEN)‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"
	@echo "$(BLUE)üí° –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: source .venv/bin/activate$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è macOS
install-mac:
	@echo "$(BLUE)üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è macOS...$(NC)"
	@$(PYTHON) -m venv .venv
	@echo "$(BLUE)üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(NC)"
	@. .venv/bin/activate && pip install --upgrade pip
	@echo "$(BLUE)üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è macOS...$(NC)"
	@. .venv/bin/activate && pip install -e .[mac]
	@echo "$(GREEN)‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è macOS –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"
	@echo "$(BLUE)üí° –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: source .venv/bin/activate$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å PyAudio, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: brew install portaudio && pip install pyaudio$(NC)"

run:
	@echo "$(BLUE)üé§ –ó–∞–ø—É—Å–∫ STT –∫–ª–∏–µ–Ω—Ç–∞...$(NC)"
	@. .venv/bin/activate && mic-stream
	@echo "$(GREEN)‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω$(NC)"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Docker –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

docker-build:
	@echo "$(BLUE)üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ —Å GPU –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π...$(NC)"
	docker compose build

docker-run:
	@echo "$(BLUE)üöÄ –ó–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...$(NC)"
	docker compose up -d
	@echo "$(GREEN)‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8011 (control) –∏ 8012 (data)$(NC)"

docker-stop:
	@echo "$(YELLOW)‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...$(NC)"
	docker compose down

docker-restart: docker-stop docker-run
	@echo "$(GREEN)üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω$(NC)"

docker-logs:
	@echo "$(BLUE)üìã –õ–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:$(NC)"
	docker compose logs -f

docker-status:
	@echo "$(BLUE)üìä –°—Ç–∞—Ç—É—Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:$(NC)"
	docker compose ps
	@echo ""
	@echo "$(BLUE)üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:$(NC)"
	docker stats --no-stream

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

deploy:
	@echo "$(BLUE)üåê –î–µ–ø–ª–æ–π –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä...$(NC)"
	git push origin master
	ssh genaminipc.awg "cd ~/dev/realtime-stt-system && git pull && docker compose down && docker compose up --build -d"
	@echo "$(GREEN)‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω$(NC)"

remote-logs:
	@echo "$(BLUE)üìã –õ–æ–≥–∏ —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:$(NC)"
	ssh genaminipc.awg "cd ~/dev/realtime-stt-system && docker compose logs -f"

remote-status:
	@echo "$(BLUE)üìä –°—Ç–∞—Ç—É—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ:$(NC)"
	ssh genaminipc.awg "cd ~/dev/realtime-stt-system && docker compose ps && echo && docker stats --no-stream"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –£—Ç–∏–ª–∏—Ç—ã
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

clean:
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.log" -delete 2>/dev/null || true
	@echo "$(GREEN)‚úÖ –ü—Ä–æ–µ–∫—Ç –æ—á–∏—â–µ–Ω$(NC)"

test-connection:
	@echo "$(BLUE)üîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...$(NC)"
	@timeout 5 bash -c "echo > /dev/tcp/genaminipc.awg/8011" && echo "$(GREEN)‚úÖ –ü–æ—Ä—Ç 8011 –¥–æ—Å—Ç—É–ø–µ–Ω$(NC)" || echo "$(RED)‚ùå –ü–æ—Ä—Ç 8011 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω$(NC)"
	@timeout 5 bash -c "echo > /dev/tcp/genaminipc.awg/8012" && echo "$(GREEN)‚úÖ –ü–æ—Ä—Ç 8012 –¥–æ—Å—Ç—É–ø–µ–Ω$(NC)" || echo "$(RED)‚ùå –ü–æ—Ä—Ç 8012 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
check-platform:
	@echo "$(BLUE)üñ•Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã...$(NC)"
	@echo "$(GREEN)–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: $(shell uname -s)$(NC)"
	@if [ "$(shell uname -s)" = "Darwin" ]; then \
		echo "$(YELLOW)üçé –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ macOS - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make install-mac' –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏$(NC)"; \
		echo "$(YELLOW)üí° –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PyAudio: brew install portaudio && pip install pyaudio$(NC)"; \
	else \
		echo "$(GREEN)üêß –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ Linux - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make install' –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏$(NC)"; \
	fi

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
.DEFAULT_GOAL := help

docker-build-no-cache:
	@echo "$(YELLOW)üê≥ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∫–µ—à–∞ (–º–µ–¥–ª–µ–Ω–Ω–æ!)...$(NC)"
	docker compose build --no-cache --progress=plain

